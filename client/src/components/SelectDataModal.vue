<script>
import {
    BModal,
    BFormGroup,
    BFormRadioGroup,
    BFormSelect
} from "bootstrap-vue";
import { mapActions, mapGetters, mapState } from "vuex";
import Spinner from "./Spinner.vue";

export default {
    name: "SelectDataModal",
    computed: {
        ...mapState("home", {
            homeSource: state => state.source,
            homeGeo: state => state.geo,
            homeLocation: state => state.location,
            homeData: state => state.data
        }),
        ...mapState("meta", ["loading", "error"]),
        ...mapGetters("meta", ["getMetaData"]),
        dataset() {
            return this.selectedSource && this.selectedGeoType
                ? this.getMetaData({
                      name: this.selectedSource,
                      type: this.selectedGeoType
                  })
                : null;
        },
        ...mapGetters("mobility", ["getMobilityData"]),
        currentMobility() {
            return this.$route.name === "Data"
                ? this.getMobilityData(this.$route.params)
                : null;
        }
    },
    data() {
        return {
            sourceOptions: ["Apple", "Google"],
            selectedSource: null,
            geoTypeOptions: [
                "Countries",
                { value: "States", text: "United States" }
            ],
            selectedGeoType: null,
            selectedLocaton: null,
            selectedData: null
        };
    },
    methods: {
        ...mapActions("meta", ["fetchMetaData"]),
        checkForMetaData() {
            const source = this.dataset ? this.dataset.name : null;
            const geo = this.dataset ? this.dataset.type : null;
            if (!this.loading) {
                if (
                    this.selectedSource &&
                    this.selectedGeoType &&
                    (this.selectedSource !== source ||
                        this.selectedGeoType !== geo)
                ) {
                    this.fetchMetaData({
                        name: this.selectedSource,
                        type: this.selectedGeoType
                    });
                }
            }
        },
        locationOptions() {
            const locationDefault = {
                value: this.dataset ? null : this.selectedLocaton,
                text: "Select a Location",
                disabled: true
            };
            if (this.dataset) {
                return [
                    locationDefault,
                    ...Array.from(Object.keys(this.dataset.data)).sort()
                ];
            } else {
                return [locationDefault];
            }
        },
        dataOptions() {
            const dataDefault = {
                value: this.dataset ? null : this.selectedData,
                text: "Select a Data Type",
                disabled: true
            };
            if (this.dataset && this.selectedLocaton in this.dataset.data) {
                return [
                    dataDefault,
                    ...Array.from(
                        this.dataset.data[this.selectedLocaton]
                    ).sort()
                ];
            } else {
                return [dataDefault];
            }
        },
        formatSelectedLocation() {
            if (!this.dataset) {
                return null;
            }
            return this.selectedLocaton;
        },
        formatSelectedData() {
            if (!this.dataset) {
                return null;
            }
            return this.selectedData;
        },
        handleOk() {
            if (this.selectedLocaton && this.selectedData) {
                this.$router.push({
                    name: "Data",
                    params: {
                        name: this.selectedLocaton,
                        type: this.selectedData
                    }
                });
            }
        }
    },
    created() {
        this.checkForMetaData();
    },
    mounted() {
        this.$refs.selectDataModal.$on("show", () => {
            this.$emit("modal-visible");
        });
        this.$on("modal-visible", () => {
            if (this.$route.name === "Home") {
                [
                    this.selectedSource,
                    this.selectedGeoType,
                    this.selectedLocaton,
                    this.selectedData
                ] = [
                    this.homeSource,
                    this.homeGeo,
                    this.homeLocation,
                    this.homeData
                ];
            } else if (this.currentMobility) {
                const { source, geo, name, type } = this.currentMobility;
                [
                    this.selectedSource,
                    this.selectedGeoType,
                    this.selectedLocaton,
                    this.selectedData
                ] = [source, geo, name, type];
            } else {
                [
                    this.selectedSource,
                    this.selectedGeoType,
                    this.selectedLocaton,
                    this.selectedData
                ] = [null, null, null, null];
            }
        });
    },
    updated() {
        if (this.dataset) {
            if (!(this.selectedLocaton in this.dataset.data)) {
                this.selectedLocaton = null;
                this.selectedData = null;
            } else if (
                !this.dataset.data[this.selectedLocaton].includes(
                    this.selectedData
                )
            ) {
                this.selectedData = null;
            }
        }

        this.checkForMetaData();
    },
    render() {
        return (
            <BModal
                id="select-data-modal"
                ref="selectDataModal"
                title="Select Mobility Data to Examine"
                ok-disabled={!this.selectedLocaton || !this.selectedData}
                onOk={this.handleOk}
                no-fade
            >
                <section class="selected-data-form">
                    <BFormGroup label="Select a Data Source:">
                        <BFormRadioGroup
                            id="select-source-radio-group"
                            vModel={this.selectedSource}
                            options={this.sourceOptions}
                            disabled={this.loading}
                        ></BFormRadioGroup>
                    </BFormGroup>
                    <BFormGroup label="Select a Region Type:">
                        <BFormRadioGroup
                            id="select-geo-type-radio-group"
                            vModel={this.selectedGeoType}
                            options={this.geoTypeOptions}
                            disabled={this.loading}
                        ></BFormRadioGroup>
                    </BFormGroup>
                    <BFormGroup>
                        <BFormSelect
                            vModel={this.selectedLocaton}
                            options={this.locationOptions()}
                            disabled={!this.dataset}
                        />
                    </BFormGroup>
                    <BFormGroup>
                        <BFormSelect
                            vModel={this.selectedData}
                            options={this.dataOptions()}
                            disabled={!this.dataset || !this.selectedLocaton}
                        />
                    </BFormGroup>
                    {this.loading ? <div class="spinner-backdrop" /> : null}
                    {this.loading ? (
                        <Spinner class="select-data-spinner" />
                    ) : null}
                </section>
            </BModal>
        );
    }
};
</script>

<style lang="scss">
.selected-data-form {
    position: relative;
}
.select-data-spinner {
    position: absolute;
    top: 0;
}
</style>